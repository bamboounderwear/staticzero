<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Minimal WebRTC Chatroom</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
    textarea { width: 100%; height: 100px; margin-bottom: 10px; }
    input[type="text"] { width: 80%; }
  </style>
</head>
<body>
  <h1>Minimal WebRTC Chatroom</h1>
  <p>
    This demo uses manual signaling â€“ you (or your peer) must copy and paste the SDP (Session Description) between browsers.
  </p>
  <div>
    <!-- Buttons for the different roles -->
    <button id="createOffer">Create Offer (Caller)</button>
    <button id="createAnswer">Create Answer (Callee)</button>
    <button id="acceptAnswer">Accept Answer (Caller)</button>
  </div>
  <div>
    <h3>SDP Exchange</h3>
    <textarea id="localSDP" placeholder="Local SDP will appear here"></textarea>
    <textarea id="remoteSDP" placeholder="Paste remote SDP here"></textarea>
  </div>
  <div>
    <h3>Chat</h3>
    <div id="chat"></div>
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendMessage">Send</button>
  </div>

  <script>
    let pc;
    let dataChannel;
    const configuration = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    // Utility to log messages to the chat div
    function logMessage(message) {
      const chatDiv = document.getElementById('chat');
      const p = document.createElement('p');
      p.textContent = message;
      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Create a new RTCPeerConnection with ICE candidate handling
    function createPeerConnection() {
      const peer = new RTCPeerConnection(configuration);
      peer.onicecandidate = event => {
        if (!event.candidate) {
          // ICE gathering finished: show the SDP in the local textarea
          document.getElementById('localSDP').value = JSON.stringify(peer.localDescription);
        }
      };
      return peer;
    }

    // --------------------
    // Caller: Create an offer and data channel
    document.getElementById('createOffer').addEventListener('click', async () => {
      pc = createPeerConnection();

      // Create a data channel for sending chat messages
      dataChannel = pc.createDataChannel("chat");
      dataChannel.onopen = () => logMessage("Data channel open");
      dataChannel.onmessage = (event) => logMessage("Peer: " + event.data);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      // The offer SDP will appear in the "Local SDP" textarea once ICE gathering is complete.
    });

    // --------------------
    // Callee: Create an answer using the offer from the remote peer
    document.getElementById('createAnswer').addEventListener('click', async () => {
      const offerSDP = document.getElementById('remoteSDP').value;
      if (!offerSDP) {
        alert("Please paste the offer SDP into the 'Paste remote SDP' field.");
        return;
      }
      pc = createPeerConnection();

      // When the caller creates a data channel, this event will fire.
      pc.ondatachannel = event => {
        dataChannel = event.channel;
        dataChannel.onopen = () => logMessage("Data channel open");
        dataChannel.onmessage = (event) => logMessage("Peer: " + event.data);
      };

      const offer = JSON.parse(offerSDP);
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      // The answer SDP will appear in the "Local SDP" textarea once ICE gathering is complete.
    });

    // --------------------
    // Caller: Accept the answer sent back from the callee
    document.getElementById('acceptAnswer').addEventListener('click', async () => {
      const answerSDP = document.getElementById('remoteSDP').value;
      if (!answerSDP) {
        alert("Please paste the answer SDP into the 'Paste remote SDP' field.");
        return;
      }
      const answer = JSON.parse(answerSDP);
      await pc.setRemoteDescription(answer);
    });

    // --------------------
    // Chat: Send a message over the data channel
    document.getElementById('sendMessage').addEventListener('click', () => {
      const input = document.getElementById('messageInput');
      const message = input.value;
      if (message && dataChannel && dataChannel.readyState === "open") {
        dataChannel.send(message);
        logMessage("You: " + message);
        input.value = "";
      }
    });
  </script>
</body>
</html>